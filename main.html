<!doctype html>
<html lang="zh-Hant">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Guitar Chord Explorer â€” Pure JS</title>
Â  <style>
Â  Â  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 18px; background:#f7fafc; color:#0f172a; }
Â  Â  .container { max-width:960px; margin:0 auto; background:white; padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
Â  Â  h1 { margin:0 0 8px 0; font-size:20px; }
Â  Â  label{ font-size:13px; display:block; margin-bottom:6px; }
Â  Â  select,input[type="text"], input[type="range"], button{ width:100%; padding:8px; border:1px solid #e6edf3; border-radius:6px; box-sizing:border-box; }
Â  Â  .grid { display:grid; gap:12px; grid-template-columns: repeat(3, 1fr); margin-bottom:12px; }
Â  Â  .row { display:flex; gap:12px; }
Â  Â  .card { padding:12px; border:1px solid #eef2f7; border-radius:8px; background:#fff; }
Â  Â  .muted { color:#64748b; font-size:13px; }
Â  Â  ul { margin:6px 0 0 18px; padding:0; }
Â  Â  .fret-grid { display:flex; gap:8px; align-items:flex-start; }
Â  Â  .string-box { width:64px; border:1px solid #e6edf3; border-radius:6px; padding:8px; text-align:center; background:#fbfdff; }
Â  Â  .string-name { font-size:12px; color:#0f172a; }
Â  Â  .fret-num { margin-top:8px; font-family: monospace; font-size:16px; }
Â  Â  .small { font-size:13px; color:#475569; }
Â  Â  .flex { display:flex; gap:8px; }
Â  Â  .col { display:flex; flex-direction:column; gap:8px; }
Â  Â  .controls { margin-bottom:12px; }
Â  Â  .notice { font-size:13px; color:#334155; margin-top:10px; }
Â  Â  .best { background:#f1f5f9; padding:8px; border-radius:6px; border:1px solid #e2e8f0; }
Â  Â  .footer { margin-top:14px; font-size:13px; color:#475569; }
Â  Â  .kbd { font-family: monospace; background:#eef2ff; padding:2px 6px; border-radius:4px; font-size:12px; }
Â  Â  @media (max-width:800px){ .grid{ grid-template-columns: 1fr; } .fret-grid{ overflow:auto;} .string-box{ min-width:56px; } }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <h1>Guitar Chord Explorer ğŸ¸</h1>
Â  Â  <p class="muted">æ¢ç´¢å’Œå¼¦çµ„æˆéŸ³èˆ‡å‰ä»–æŒ‡æ³•ã€‚</p>

Â  Â  <div class="grid controls">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Keyï¼ˆæ­Œæ›²èª¿æ€§ï¼‰</label>
Â  Â  Â  Â  <select id="keySelect"></select>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Transposeï¼ˆåŠéŸ³ï¼‰ <span id="transposeVal">0</span></label>
Â  Â  Â  Â  <input id="transpose" type="range" min="-6" max="6" value="0" />
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>é¡¯ç¤ºéŸ³ååå¥½</label>
Â  Â  Â  Â  <label style="display:flex;align-items:center;gap:8px;"><input id="useFlats" type="checkbox" /> ä½¿ç”¨é™è¨˜è™Ÿï¼ˆBbã€Ebï¼‰</label>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="row" style="margin-bottom:12px;">
Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  <label>è¼¸å…¥ **å’Œå¼¦çµ„æˆéŸ³**ï¼ˆä¾‹ï¼š<span class="kbd">C E G</span>ï¼‰</label>
Â  Â  Â  Â  <input id="chordInput" type="text" value="C E G" />
Â  Â  Â  </div>
Â  Â  Â  <div style="width:140px;">
Â  Â  Â  Â  <label>&nbsp;</label>
Â  Â  Â  Â  <button id="analyzeNotesBtn" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc;">ğŸµ æ‰¾å’Œå¼¦å</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="row" style="margin-bottom:12px;">
Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  <label>è¼¸å…¥ **å’Œå¼¦åç¨±**ï¼ˆä¾‹ï¼š<span class="kbd">Cm7</span> æˆ– <span class="kbd">G/B</span>ï¼‰</label>
Â  Â  Â  Â  <input id="nameInput" type="text" value="Cm7" />
Â  Â  Â  </div>
Â  Â  Â  <div style="width:140px;">
Â  Â  Â  Â  <label>&nbsp;</label>
Â  Â  Â  Â  <button id="analyzeNameBtn" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#eff6ff;">ğŸ”¢ æ‰¾çµ„æˆéŸ³</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row" style="gap:18px;">
Â  Â  Â  <div class="card" style="flex:1;">
Â  Â  Â  Â  <h3 style="margin:0 0 8px 0;">è¾¨è­˜çµæœ</h3>
Â  Â  Â  Â  <div id="pcsDisplay" class="small muted">è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼šâ€”</div>
        <div id="nameResult" style="margin-top:8px;"></div>
        
Â  Â  Â  Â  <div id="possibleList" style="margin-top:8px;">
Â  Â  Â  Â  Â  <div class="small muted">å¯èƒ½å’Œå¼¦ï¼ˆå¾çµ„æˆéŸ³è§£æï¼‰ï¼š</div>
Â  Â  Â  Â  Â  <ul id="matches"></ul>
Â  Â  Â  Â  </div>
        Â  Â  Â  Â  <div id="bestMatch" style="margin-top:8px;"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card" style="width:360px;">
Â  Â  Â  Â  <h3 style="margin:0 0 8px 0;">å‰ä»–æŒ‡æ³•ç¤ºæ„</h3>
Â  Â  Â  Â  <div class="small" id="fretInfo">å»ºè­°æŠŠä½ï¼šâ€”</div>
Â  Â  Â  Â  <div style="height:10px;"></div>
Â  Â  Â  Â  <div class="fret-grid" id="fretGrid"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="footer">
Â  Â  Â  <strong></strong>Â 
Â  Â  </div>
Â  </div>

<script>
const NOTE_NAMES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTE_NAMES_FLATÂ  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const MAJOR_KEYS = ["C","G","D","A","E","B","F#","C#","F","Bb","Eb","Ab","Db","Gb"];

// å‰ä»–æ¨™æº–å®šå¼¦ (E A D G B e) å°æ‡‰çš„ PC å€¼
const GUITAR_STRINGS = [4,9,2,7,11,4];
const displayedLabels = ["E", "A", "D", "G", "B", "E'"];Â  // å·¦â†’å³ = 6â†’1 (E-low to e-high)

const CHORD_PATTERNS = [
Â  {name:"maj", intervals:[0,4,7], aliases:[""]},
Â  {name:"min", intervals:[0,3,7], aliases:["m","-"]},
Â  {name:"dim", intervals:[0,3,6], aliases:["dim","o"]},
Â  {name:"aug", intervals:[0,4,8], aliases:["+","aug"]},
Â  {name:"sus2", intervals:[0,2,7], aliases:["sus2"]},
Â  {name:"sus4", intervals:[0,5,7], aliases:["sus4","sus"]},
Â  {name:"6", intervals:[0,4,7,9], aliases:["6"]},
Â  {name:"m6", intervals:[0,3,7,9], aliases:["m6"]},
Â  {name:"7", intervals:[0,4,7,10], aliases:["7","dom7"]},
Â  {name:"maj7", intervals:[0,4,7,11], aliases:["maj7","M7"]},
Â  {name:"m7", intervals:[0,3,7,10], aliases:["m7"]},
Â  {name:"mMaj7", intervals:[0,3,7,11], aliases:["mMaj7"]},
Â  {name:"dim7", intervals:[0,3,6,9], aliases:["dim7"]},
Â  {name:"m7b5", intervals:[0,3,6,10], aliases:["m7b5","Ã¸"]},
Â  {name:"add9", intervals:[0,4,7,14], aliases:["add9"]},
Â  {name:"9", intervals:[0,4,7,10,14], aliases:["9"]},
Â  {name:"11", intervals:[0,4,7,10,14,17], aliases:["11"]},
Â  {name:"13", intervals:[0,4,7,10,14,17,21], aliases:["13"]},
Â  {name:"sus2add6", intervals:[0,2,7,9], aliases:["sus2add6"]},
Â  {name:"sus4add9", intervals:[0,5,7,14], aliases:["sus4add9"]},
Â  {name:"5", intervals:[0,7], aliases:["5","power"]},
Â  {name:"add11", intervals:[0,4,7,17], aliases:["add11"]},
Â  {name:"add2", intervals:[0,4,7,2], aliases:["add2"]},
Â  {name:"maj9", intervals:[0,4,7,11,14], aliases:["maj9"]},
Â  {name:"aug7", intervals:[0,4,8,10], aliases:["aug7"]},
Â  {name:"7b5", intervals:[0,4,6,10], aliases:["7b5"]},
];

// å’Œå¼¦åç¨±åˆ°å…¶æ¨¡å¼çš„æ˜ å°„
const CHORD_NAME_MAP = new Map();
CHORD_PATTERNS.forEach(pat => {
    CHORD_NAME_MAP.set(pat.name.toLowerCase(), pat);
    if (pat.aliases) {
        pat.aliases.forEach(alias => {
            if (alias) CHORD_NAME_MAP.set(alias.toLowerCase(), pat);
        });
    }
});


function noteToPc(note) {
Â  if(!note) return null;
Â  let s = note.trim();
Â  s = s.replace(//g,'').replace(/â™¯/g,'#').replace(/â™­/g,'b');
Â  if(s.length === 0) return null;
Â  const base = s[0].toUpperCase();
Â  const accidental = s.slice(1);
Â  const trySharp = NOTE_NAMES_SHARP.indexOf(base + accidental);
Â  if(trySharp !== -1) return trySharp;
Â  const tryFlat = NOTE_NAMES_FLAT.indexOf(base + accidental);
Â  if(tryFlat !== -1) return tryFlat;
Â  if(accidental === '#' ) {
Â  Â  const idx = NOTE_NAMES_SHARP.indexOf(base);
Â  Â  return (idx + 1) % 12;
Â  }
Â  if(accidental === 'b') {
Â  Â  const idx = NOTE_NAMES_SHARP.indexOf(base);
Â  Â  return (idx + 11) % 12;
Â  }
Â  const idx = NOTE_NAMES_SHARP.indexOf(base);
Â  if(idx !== -1) return idx;
Â  return null;
}

function pcsToNames(pcs, preferFlats=false) {
Â  const map = preferFlats ? NOTE_NAMES_FLAT : NOTE_NAMES_SHARP;
Â  return pcs.map(p => map[((p%12)+12)%12]);
}

function uniqueSorted(arr){ return Array.from(new Set(arr.map(x=>((x%12)+12)%12))).sort((a,b)=>a-b); }

function intervalsFromRoot(root, pcs) {
Â  const uniq = uniqueSorted(pcs);
Â  const ints = uniq.map(p => ((p - root) % 12 + 12) % 12).sort((a,b)=>a-b);
Â  return ints;
}

function matchPattern(intervals) {
Â  const matches = [];
Â  const intSet = new Set(intervals.map(i=>i%12));
Â  for(const pat of CHORD_PATTERNS) {
Â  Â  const patSet = new Set(pat.intervals.map(i=>i%12));
Â  Â  let ok = true;
Â  Â  for(const v of patSet) if(!intSet.has(v)) { ok = false; break; }
Â  Â  if(ok) matches.push(pat);
Â  }
Â  return matches;
}

function identifyChordsFromPcs(pcs) {
Â  const uniquePcs = uniqueSorted(pcs);
Â  const results = [];
Â  for(const root of uniquePcs) {
Â  Â  const ints = intervalsFromRoot(root, uniquePcs);
Â  Â  const patterns = matchPattern(ints);
Â  Â  for(const pat of patterns) {
Â  Â  Â  // è¨ˆç®—åˆ†æ•¸ï¼šåŒ¹é…åˆ°çš„éŸ³ç¨‹æ•¸*10 - è¼¸å…¥çš„ç¸½éŸ³ç¨‹æ•¸ (åå¥½åŒ¹é…æ›´å¤šéŸ³ç¨‹çš„æ¨¡å¼)
Â  Â  Â  const score = pat.intervals.length*10 - ints.length; 
Â  Â  Â  results.push({root, pat, display: `${NOTE_NAMES_SHARP[root]}${pat.aliases[0] || pat.name}`, score, intervals:ints});
Â  Â  }
Â  }
Â  results.sort((a,b)=>b.score-a.score);
Â  return results;
}

function findFretboard(pcs, maxFret=12, baseFretLimit=5, span=4) {
Â  const target = pcs.map(p=>((p%12)+12)%12);
Â  const candidates = [];
Â  for(let base=0;base<=maxFret-span;base++){ // baseFretLimit è¨­ç‚º maxFret-span è®“æŒ‡æ¿æ›´å½ˆæ€§
Â  Â  const fingering = [];
Â  Â  for(let s=0;s<6;s++){
Â  Â  Â  const openPc = GUITAR_STRINGS[s];
Â  Â  Â  let chosen = null;
Â  Â  Â  
      // å°‹æ‰¾åœ¨ç•¶å‰æŠŠä½ (base åˆ° base+span) å…§ï¼Œæ˜¯å¦èƒ½å½ˆå‡ºç›®æ¨™éŸ³
Â  Â  Â  for(let f=0; f<=maxFret; f++){
Â  Â  Â  Â  const pc = (openPc + f) % 12;
Â  Â  Â  Â  
        // ç¢ºä¿åœ¨æŠŠä½ç¯„åœå…§ï¼šé–‹æ”¾å¼¦(0) æˆ– (base <= f <= base+span)
        const inSpan = (f===0) || (f >= base && f <= base+span);

Â  Â  Â  Â  if(target.includes(pc) && inSpan){ 
          chosen = f; 
          break; 
        }
Â  Â  Â  }
Â  Â  Â  fingering.push(chosen);
Â  Â  }
Â  Â  
Â  Â  const matched = fingering.filter(f => f !== null).length;
    // æ‰¾å‡ºæœ€ä½å’Œæœ€é«˜æŒ‡æ¿ä½ç½®ï¼Œå¿½ç•¥ç©ºå¼¦ (0) å’Œæœªå½ˆå¥ (null)
Â  Â  const playedFrets = fingering.filter(f => f !== null && f !== 0);
    const maxF = playedFrets.length > 0 ? Math.max(...playedFrets) : 0;
    const minF = playedFrets.length > 0 ? Math.min(...playedFrets) : 0;
    
Â  Â  const range = maxF - minF;
    const isBarre = (matched > 3 && minF > 0); // ç°¡åŒ–åˆ¤æ–·æ˜¯å¦ç‚ºå°é–‰å’Œå¼¦

Â  Â  // è©•åˆ†æ¨™æº–: åŒ¹é…å¼¦æ•¸ (æ¬Šé‡é«˜) - è·¨åº¦ (æ¬Šé‡ä½) + æ˜¯å¦ç‚ºé–‹æ”¾å’Œå¼¦
Â  Â  const score = matched*10 - range + (minF === 0 ? 5 : 0); 
    
Â  Â  candidates.push({base, fingering, score, matched, minF, maxF});
Â  }
Â  candidates.sort((a,b)=>b.score-a.score);
Â  return candidates[0];
}


// --- DOM å…ƒç´ ç²å– ---
const keySelect = document.getElementById('keySelect');
const transposeEl = document.getElementById('transpose');
const transposeVal = document.getElementById('transposeVal');
const useFlatsEl = document.getElementById('useFlats');

const chordInput = document.getElementById('chordInput');
const nameInput = document.getElementById('nameInput');
const analyzeNotesBtn = document.getElementById('analyzeNotesBtn'); 
const analyzeNameBtn = document.getElementById('analyzeNameBtn');

const pcsDisplay = document.getElementById('pcsDisplay');
const nameResultEl = document.getElementById('nameResult');
const matchesEl = document.getElementById('matches');
const bestMatchEl = document.getElementById('bestMatch');
const fretInfo = document.getElementById('fretInfo');
const fretGrid = document.getElementById('fretGrid');

function populateKeys(){
Â  MAJOR_KEYS.forEach(k => {
Â  Â  const opt = document.createElement('option'); opt.value = k; opt.textContent = k;
Â  Â  keySelect.appendChild(opt);
Â  });
}
populateKeys();

function parseInputToPcs(text, transpose=0) {
Â  if(!text) return [];
Â  const cleaned = text.replace(/[()]/g,' ').replace(/[\/,]+/g,' ').trim();
Â  if(cleaned.length===0) return [];
Â  const tokens = cleaned.split(/\s+/);
Â  const pcs = tokens.map(t => noteToPc(t)).filter(x => x !== null).map(n => ((n + transpose) % 12 + 12) % 12);
Â  return pcs;
}

function renderFretGrid(fb) {
Â  fretGrid.innerHTML = "";
Â  // éæ­· GUITAR_STRINGS é™£åˆ— (E A D G B e)
Â  for(let s=0;s<6;s++){
Â  Â  const box = document.createElement('div');
Â  Â  box.className = 'string-box';
Â  Â  const label = document.createElement('div');
Â  Â  label.className = 'string-name';
Â  Â  label.textContent = displayedLabels[s]; // ä½¿ç”¨ E A D G B E' æ¨™ç±¤

Â  Â  const fret = document.createElement('div');
Â  Â  fret.className = 'fret-num';

Â  Â  let val = 'â€”';
Â  Â  if(fb && fb.fingering){
Â  Â  Â  const fing = fb.fingering[s];
Â  Â  Â  val = (fing === null) ? 'X' : String(fing);
Â  Â  } else {
Â  Â  Â  val = 'â€”';
Â  Â  }

Â  Â  fret.textContent = val;
Â  Â  box.appendChild(label);
Â  Â  box.appendChild(fret);
Â  Â  fretGrid.appendChild(box);
Â  }
}


// --- æ–°å¢ï¼šå’Œå¼¦åç¨±è§£æåŠŸèƒ½ ---
function parseChordName(chordName, transpose = 0) {
    if (!chordName) return { pcs: [], rootName: null, typeName: null, bassName: null };
    
    let bestMatch = null;
    let longestMatchLen = 0;

    // 1. è™•ç† Slash Chord (G/B, C/E)
    const parts = chordName.split('/');
    let mainName = parts[0].trim();
    const bassNote = parts.length > 1 ? parts[1].trim() : null;
    
    // 2. æ‰¾å‡º Root Note å’Œ Chord Type
    const allNotes = [...NOTE_NAMES_SHARP, ...NOTE_NAMES_FLAT].sort((a,b)=>b.length-a.length);
    
    for(const note of allNotes) {
        if (mainName.toUpperCase().startsWith(note.toUpperCase())) {
            const typeCandidate = mainName.substring(note.length).trim();
            
            // å˜—è©¦å¾é¡å‹å€™é¸å­—ä¸²ä¸­æ‰¾å‡ºæœ€æ¥è¿‘çš„å’Œå¼¦æ¨¡å¼
            for (const [alias, pattern] of CHORD_NAME_MAP.entries()) {
                if (typeCandidate.toLowerCase() === alias.toLowerCase()) {
                    bestMatch = { root: note, type: pattern, typeStr: typeCandidate };
                    longestMatchLen = note.length;
                    break;
                }
            }
            
            // è™•ç†é è¨­ Major å’Œå¼¦ (ä¾‹å¦‚: C, G, A#)
            if (typeCandidate.length === 0) {
                const majorPat = CHORD_NAME_MAP.get("maj");
                bestMatch = { root: note, type: majorPat, typeStr: "" };
                longestMatchLen = note.length;
                break; 
            }
        }
    }
    
    if (!bestMatch) return { pcs: [], rootName: null, typeName: null, bassName: null };

    // 3. è¨ˆç®— Pitch Classes
    const rootPc = noteToPc(bestMatch.root);
    const pattern = bestMatch.type;
    let pcs = pattern.intervals.map(interval => (rootPc + interval) % 12);
    
    // 4. è™•ç† Bass Note
    let bassPc = null;
    if (bassNote) {
        bassPc = noteToPc(bassNote);
        if (bassPc !== null) {
            pcs.push(bassPc); // å°‡ä½éŸ³åŠ å…¥çµ„æˆéŸ³åˆ—è¡¨
        }
    }
    
    // 5. æ‡‰ç”¨è½‰èª¿ (Transpose)
    pcs = pcs.map(p => ((p + transpose) % 12 + 12) % 12);

    return { 
        pcs: uniqueSorted(pcs),
        rootName: bestMatch.root, 
        typeName: bestMatch.typeStr, 
        bassName: bassNote 
    };
}


// --- çµ±ä¸€çš„å‰ä»–æŒ‡æ³•æ›´æ–°é‚è¼¯ ---
function updateFretboard(uniquePcs) {
    const fb = findFretboard(uniquePcs);
    if(!fb) {
        fretInfo.textContent = "å»ºè­°æŠŠä½ï¼šç„¡";
        renderFretGrid(null);
    } else {
        fretInfo.textContent = `å»ºè­°æŠŠä½ï¼ˆæœ€ä½æŒ‡ ${fb.minF}ï¼Œæœ€é«˜æŒ‡ ${fb.maxF}ï¼ŒåŒ¹é…å¼¦ ${fb.matched}/6ï¼‰`;
        renderFretGrid(fb);
    }
}

// --- è™•ç†å¾ **çµ„æˆéŸ³** æ‰¾ **å’Œå¼¦åç¨±** çš„é‚è¼¯ (ğŸµ æ‰¾å’Œå¼¦å) ---
function analyzeNotesToName() {
    const transpose = Number(transposeEl.value) || 0;
    const pcs = parseInputToPcs(chordInput.value, transpose);
    const preferFlats = useFlatsEl.checked;
    
    // æ¸…ç©º NameToNotes çš„çµæœ
    nameResultEl.innerHTML = "";
    bestMatchEl.innerHTML = ""; // é‡ç”¨ bestMatchEl é¡¯ç¤ºæœ€ä½³åŒ¹é…

    if (pcs.length === 0){
        pcsDisplay.textContent = "è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼šâ€”";
        matchesEl.innerHTML = "<li>å°šæœªè¼¸å…¥æˆ–è§£æå‡ºæœ‰æ•ˆéŸ³ã€‚</li>";
        fretInfo.textContent = "å»ºè­°æŠŠä½ï¼šâ€”";
        renderFretGrid(null);
        return;
    }

    const uniquePcs = uniqueSorted(pcs);
    pcsDisplay.textContent = "è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼š" + pcsToNames(uniquePcs, preferFlats).join(', ');

    const idents = identifyChordsFromPcs(uniquePcs);
    matchesEl.innerHTML = "";
    if(idents.length === 0){
        matchesEl.innerHTML = "<li>æ‰¾ä¸åˆ°åŒ¹é…çš„å¸¸è¦‹å’Œå¼¦æ¨¡å¼</li>";
        bestMatchEl.innerHTML = "";
    } else {
        idents.slice(0,10).forEach(r => {
            const li = document.createElement('li');
            const rootNote = preferFlats ? pcsToNames([r.root], true)[0] : NOTE_NAMES_SHARP[r.root];
            li.textContent = `${rootNote}${r.pat.aliases[0] || r.pat.name} â€” (éŸ³ç¨‹: [${r.intervals.join(', ')}])`;
            matchesEl.appendChild(li);
        });

        const best = idents[0];
        const rootNote = preferFlats ? pcsToNames([best.root], true)[0] : NOTE_NAMES_SHARP[best.root];
        bestMatchEl.innerHTML = `<div class="best"><strong>æœ€ä½³åŒ¹é…ï¼š</strong> ${rootNote}${best.pat.aliases[0] || best.pat.name}</div>`;
    }

    // æ›´æ–°å‰ä»–æŒ‡æ³•
    updateFretboard(uniquePcs);
}

// --- è™•ç†å¾ **å’Œå¼¦åç¨±** æ‰¾ **çµ„æˆéŸ³** çš„é‚è¼¯ (ğŸ”¢ æ‰¾çµ„æˆéŸ³) ---
function analyzeNameToNotes() {
    const transpose = Number(transposeEl.value) || 0;
    const preferFlats = useFlatsEl.checked;
    const chordName = nameInput.value;
    
    // æ¸…ç©º NotesToName çš„çµæœ
    matchesEl.innerHTML = "";
    bestMatchEl.innerHTML = "";

    const { pcs, rootName, typeName, bassName } = parseChordName(chordName, transpose);
    
    nameResultEl.innerHTML = "";
    
    if (pcs.length === 0) {
        pcsDisplay.textContent = "è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼šâ€”";
        nameResultEl.innerHTML = `<div class="small muted">å’Œå¼¦åç¨±è§£æå¤±æ•—æˆ–ç„¡æ•ˆã€‚</div>`;
        fretInfo.textContent = "å»ºè­°æŠŠä½ï¼šâ€”";
        renderFretGrid(null);
        return;
    }
    
    const displayPcs = pcsToNames(pcs, preferFlats).join(', ');
    const displayName = `${rootName}${typeName}${bassName ? '/' + bassName : ''}`;

    // é¡¯ç¤ºçµæœ
    pcsDisplay.textContent = "è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼š" + displayPcs;
    nameResultEl.innerHTML = `<div class="best"><strong>å’Œå¼¦åç¨±è§£æçµæœï¼š</strong> ${displayName}</div>`;

    // æ›´æ–°å‰ä»–æŒ‡æ³•
    updateFretboard(pcs);
}

// è™•ç†è½‰èª¿/åå¥½è¨­å®šè®Šæ›´æ™‚çš„ UI æ›´æ–°
function updateUI() {
    const transpose = Number(transposeEl.value) || 0;
    transposeVal.textContent = (transpose >= 0 ? `+${transpose}` : `${transpose}`);
    
    // é è¨­åŸ·è¡Œçµ„æˆéŸ³æ‰¾å’Œå¼¦
    analyzeNotesToName();
}

// --- äº‹ä»¶ç›£è½ ---
analyzeNotesBtn.addEventListener('click', analyzeNotesToName);
analyzeNameBtn.addEventListener('click', analyzeNameToNotes);

// è½‰èª¿å’Œåå¥½è¨­å®šæ”¹è®Šæ™‚ï¼Œé è¨­é‡æ–°åŸ·è¡Œçµ„æˆéŸ³è§£æ
transposeEl.addEventListener('input', analyzeNotesToName);
useFlatsEl.addEventListener('change', analyzeNotesToName);

// Enter éµè™•ç†
chordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); analyzeNotesToName(); } });
nameInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); analyzeNameToNotes(); } });

updateUI(); // åˆå§‹è¼‰å…¥
</script>
</body>
</html>
