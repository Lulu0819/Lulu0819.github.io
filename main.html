<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guitar Chord Explorer â€” Pure JS</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 18px; background:#f7fafc; color:#0f172a; }
    .container { max-width:960px; margin:0 auto; background:white; padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
    h1 { margin:0 0 8px 0; font-size:20px; }
    label{ font-size:13px; display:block; margin-bottom:6px; }
    select,input[type="text"], input[type="range"]{ width:100%; padding:8px; border:1px solid #e6edf3; border-radius:6px; box-sizing:border-box; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(3, 1fr); margin-bottom:12px; }
    .row { display:flex; gap:12px; }
    .card { padding:12px; border:1px solid #eef2f7; border-radius:8px; background:#fff; }
    .muted { color:#64748b; font-size:13px; }
    ul { margin:6px 0 0 18px; padding:0; }
    .fret-grid { display:flex; gap:8px; align-items:flex-start; }
    .string-box { width:64px; border:1px solid #e6edf3; border-radius:6px; padding:8px; text-align:center; background:#fbfdff; }
    .string-name { font-size:12px; color:#0f172a; }
    .fret-num { margin-top:8px; font-family: monospace; font-size:16px; }
    .small { font-size:13px; color:#475569; }
    .flex { display:flex; gap:8px; }
    .col { display:flex; flex-direction:column; gap:8px; }
    .controls { margin-bottom:12px; }
    .notice { font-size:13px; color:#334155; margin-top:10px; }
    .best { background:#f1f5f9; padding:8px; border-radius:6px; border:1px solid #e2e8f0; }
    .footer { margin-top:14px; font-size:13px; color:#475569; }
    .kbd { font-family: monospace; background:#eef2ff; padding:2px 6px; border-radius:4px; font-size:12px; }
    @media (max-width:800px){ .grid{ grid-template-columns: 1fr; } .fret-grid{ overflow:auto;} .string-box{ min-width:56px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Guitar Chord Explorer ğŸ¸ï¼ˆç´” HTML + JS å¯ç›´æ¥é è¦½ï¼‰</h1>
    <p class="muted">è¼¸å…¥å’Œå¼¦çš„çµ„æˆéŸ³ï¼ˆä¾‹ï¼š<span class="kbd">C E G</span> æˆ– <span class="kbd">G,B,D,F#</span>ï¼‰ã€‚ä¸‹æ–¹æœƒé¡¯ç¤ºè¾¨è­˜çµæœèˆ‡å‰ä»–æŒ‡æ³•å»ºè­°ã€‚</p>

    <div class="grid controls">
      <div class="card">
        <label>Keyï¼ˆæ­Œæ›²èª¿æ€§ï¼‰</label>
        <select id="keySelect"></select>
      </div>

      <div class="card">
        <label>Transposeï¼ˆåŠéŸ³ï¼‰ <span id="transposeVal">0</span></label>
        <input id="transpose" type="range" min="-6" max="6" value="0" />
      </div>

      <div class="card">
        <label>é¡¯ç¤ºéŸ³ååå¥½</label>
        <label style="display:flex;align-items:center;gap:8px;"><input id="useFlats" type="checkbox" /> ä½¿ç”¨é™è¨˜è™Ÿï¼ˆBbã€Ebï¼‰</label>
      </div>
    </div>

    <div class="row" style="margin-bottom:12px;">
      <div style="flex:1;">
        <label>å’Œå¼¦çµ„æˆéŸ³ï¼ˆå¯ç”¨ç©ºç™½ã€é€—è™Ÿæˆ–æ–œç·šåˆ†éš”ï¼›å¯åŒ…å«æ‹¬è™Ÿï¼‰</label>
        <input id="chordInput" type="text" value="C E G" />
      </div>
      <div style="width:140px;">
        <label>&nbsp;</label>
        <button id="analyzeBtn" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc;">è§£æ</button>
      </div>
    </div>

    <div class="row" style="gap:18px;">
      <div class="card" style="flex:1;">
        <h3 style="margin:0 0 8px 0;">è¾¨è­˜çµæœ</h3>
        <div id="pcsDisplay" class="small muted">è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼šâ€”</div>
        <div id="possibleList" style="margin-top:8px;">
          <div class="small muted">å¯èƒ½å’Œå¼¦ï¼š</div>
          <ul id="matches"></ul>
        </div>
        <div id="bestMatch" style="margin-top:8px;"></div>
      </div>

      <div class="card" style="width:360px;">
        <h3 style="margin:0 0 8px 0;">å‰ä»–æŒ‡æ³•ç¤ºæ„</h3>
        <div class="small" id="fretInfo">å»ºè­°æŠŠä½ï¼šâ€”</div>
        <div style="height:10px;"></div>
        <div class="fret-grid" id="fretGrid"></div>
      </div>
    </div>

    <div class="footer">
      <strong>èªªæ˜ï¼š</strong> æœ¬å·¥å…·ä»¥ã€Œå’Œå¼¦çµ„æˆéŸ³ã€ç‚ºè¼¸å…¥ï¼Œå˜—è©¦æ¯”å°å¤§é‡å¸¸è¦‹èˆ‡é€²éšå’Œå¼¦æ¨¡å¼ï¼ˆåŒ…å«å¤§/å°/å¢/æ¸›/7/maj7/m7/m7b5/åŠæ¸›/aug/7b5/add/sus/5 ç­‰ï¼‰ã€‚è‹¥è¦æˆ‘åŠ å…¥ã€Œç›´æ¥è§£æå’Œå¼¦æ–‡å­—ï¼ˆä¾‹å¦‚ Em7 / Cmaj7/Gï¼‰ã€ï¼Œæˆ‘å¯ä»¥å†å¹«ä½ æ“´å……ã€‚
    </div>
  </div>

<script>
/* ---------- Data & Helpers ---------- */

const NOTE_NAMES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTE_NAMES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const MAJOR_KEYS = ["C","G","D","A","E","B","F#","C#","F","Bb","Eb","Ab","Db","Gb"];

// Guitar strings: low(6) -> high(1) pitch classes (E A D G B E)
const GUITAR_STRINGS = [4,9,2,7,11,4];

// NOTE: fingering index 0 => low E (6th string), index 5 => high E (1st string)

/* chord patterns (intervals in semitones from root) */
const CHORD_PATTERNS = [
  {name:"maj", intervals:[0,4,7], aliases:[""]},
  {name:"min", intervals:[0,3,7], aliases:["m","-"]},
  {name:"dim", intervals:[0,3,6], aliases:["dim","o"]},
  {name:"aug", intervals:[0,4,8], aliases:["+","aug"]},
  {name:"sus2", intervals:[0,2,7], aliases:["sus2"]},
  {name:"sus4", intervals:[0,5,7], aliases:["sus4","sus"]},
  {name:"6", intervals:[0,4,7,9], aliases:["6"]},
  {name:"m6", intervals:[0,3,7,9], aliases:["m6"]},
  {name:"7", intervals:[0,4,7,10], aliases:["7","dom7"]},
  {name:"maj7", intervals:[0,4,7,11], aliases:["maj7","M7"]},
  {name:"m7", intervals:[0,3,7,10], aliases:["m7"]},
  {name:"mMaj7", intervals:[0,3,7,11], aliases:["mMaj7"]},
  {name:"dim7", intervals:[0,3,6,9], aliases:["dim7"]},
  {name:"m7b5", intervals:[0,3,6,10], aliases:["m7b5","Ã¸"]},
  {name:"add9", intervals:[0,4,7,14], aliases:["add9"]},
  {name:"9", intervals:[0,4,7,10,14], aliases:["9"]},
  {name:"11", intervals:[0,4,7,10,14,17], aliases:["11"]},
  {name:"13", intervals:[0,4,7,10,14,17,21], aliases:["13"]},
  {name:"sus2add6", intervals:[0,2,7,9], aliases:["sus2add6"]},
  {name:"sus4add9", intervals:[0,5,7,14], aliases:["sus4add9"]},
  {name:"5", intervals:[0,7], aliases:["5","power"]},
  {name:"add11", intervals:[0,4,7,17], aliases:["add11"]},
  {name:"add2", intervals:[0,4,7,2], aliases:["add2"]},
  {name:"maj9", intervals:[0,4,7,11,14], aliases:["maj9"]},
  {name:"aug7", intervals:[0,4,8,10], aliases:["aug7"]},
  {name:"7b5", intervals:[0,4,6,10], aliases:["7b5"]},
];

/* parse note -> pitch class (0..11) */
function noteToPc(note) {
  if(!note) return null;
  let s = note.trim();
  s = s.replace(/ï¿½/g,'').replace(/â™¯/g,'#').replace(/â™­/g,'b');
  if(s.length === 0) return null;
  // uppercase letter
  const base = s[0].toUpperCase();
  const accidental = s.slice(1);
  // try direct names in sharp and flat tables
  const trySharp = NOTE_NAMES_SHARP.indexOf(base + accidental);
  if(trySharp !== -1) return trySharp;
  const tryFlat = NOTE_NAMES_FLAT.indexOf(base + accidental);
  if(tryFlat !== -1) return tryFlat;
  // single accidental handling
  if(accidental === '#' ) {
    const idx = NOTE_NAMES_SHARP.indexOf(base);
    return (idx + 1) % 12;
  }
  if(accidental === 'b') {
    const idx = NOTE_NAMES_SHARP.indexOf(base);
    return (idx + 11) % 12;
  }
  // fallback: single letter
  const idx = NOTE_NAMES_SHARP.indexOf(base);
  if(idx !== -1) return idx;
  return null;
}

function pcsToNames(pcs, preferFlats=false) {
  const map = preferFlats ? NOTE_NAMES_FLAT : NOTE_NAMES_SHARP;
  return pcs.map(p => map[((p%12)+12)%12]);
}

function uniqueSorted(arr){ return Array.from(new Set(arr.map(x=>((x%12)+12)%12))).sort((a,b)=>a-b); }

/* intervals from root */
function intervalsFromRoot(root, pcs) {
  const uniq = uniqueSorted(pcs);
  const ints = uniq.map(p => ((p - root) % 12 + 12) % 12).sort((a,b)=>a-b);
  return ints;
}

/* match patterns where pattern intervals subset of intervals */
function matchPattern(intervals) {
  const matches = [];
  const intSet = new Set(intervals.map(i=>i%12));
  for(const pat of CHORD_PATTERNS) {
    const patSet = new Set(pat.intervals.map(i=>i%12));
    let ok = true;
    for(const v of patSet) if(!intSet.has(v)) { ok = false; break; }
    if(ok) matches.push(pat);
  }
  return matches;
}

function identifyChordsFromPcs(pcs) {
  const uniquePcs = uniqueSorted(pcs);
  const results = [];
  for(const root of uniquePcs) {
    const ints = intervalsFromRoot(root, uniquePcs);
    const patterns = matchPattern(ints);
    for(const pat of patterns) {
      const rootName = NOTE_NAMES_SHARP[root];
      const alias = (pat.aliases && pat.aliases[0]) ? pat.aliases[0] : pat.name;
      const display = `${rootName}${alias}`;
      const score = pat.intervals.length*10 - ints.length;
      results.push({root, pat, display, score, intervals:ints});
    }
  }
  results.sort((a,b)=>b.score-a.score);
  return results;
}

/* Heuristic fret finder: for each string (low->high), pick fret 0..max that matches any pc in pcs.
   Try different base window positions and choose best by matched count and compact range. */
function findFretboard(pcs, maxFret=12, baseFretLimit=5, span=4) {
  const target = pcs.map(p=>((p%12)+12)%12);
  const candidates = [];
  for(let base=0;base<=baseFretLimit;base++){
    const fingering = [];
    for(let s=0;s<6;s++){
      const openPc = GUITAR_STRINGS[s];
      let chosen = null;
      for(let f=0; f<=Math.min(maxFret, base+span); f++){
        const pc = (openPc + f) % 12;
        if(target.includes(pc)){ chosen = f; break; }
      }
      fingering.push(chosen);
    }
    const matched = fingering.filter(f => f !== null).length;
    const numeric = fingering.map(f=> f===null?0:f);
    const maxF = Math.max(...numeric);
    const minF = Math.min(...numeric);
    const range = maxF - minF;
    const score = matched*10 - range;
    candidates.push({base, fingering, score});
  }
  candidates.sort((a,b)=>b.score-a.score);
  return candidates[0];
}

/* ---------- UI wiring ---------- */

const keySelect = document.getElementById('keySelect');
const transposeEl = document.getElementById('transpose');
const transposeVal = document.getElementById('transposeVal');
const useFlatsEl = document.getElementById('useFlats');
const chordInput = document.getElementById('chordInput');
const analyzeBtn = document.getElementById('analyzeBtn');

const pcsDisplay = document.getElementById('pcsDisplay');
const matchesEl = document.getElementById('matches');
const bestMatchEl = document.getElementById('bestMatch');
const fretInfo = document.getElementById('fretInfo');
const fretGrid = document.getElementById('fretGrid');

function populateKeys(){
  MAJOR_KEYS.forEach(k => {
    const opt = document.createElement('option'); opt.value = k; opt.textContent = k;
    keySelect.appendChild(opt);
  });
}
populateKeys();

/* strings label order for small fretboard display:
   We want the visual order (left -> right) such that reading RIGHT -> LEFT equals:
   E'  B  G  D  A  E   (i.e. 1st -> 6th when read from right to left)
   To make glance mapping simple, we'll store labels in array aligned with displayed boxes:
   displayedLabels[s] with s from 0..5 corresponds to fingering index 5 - s
*/
const displayedLabels = ["E'","B","G","D","A","E"];

function parseInputToPcs(text, transpose=0) {
  if(!text) return [];
  const cleaned = text.replace(/[()]/g,' ').replace(/[\/,]+/g,' ').trim();
  if(cleaned.length===0) return [];
  const tokens = cleaned.split(/\s+/);
  const pcs = tokens.map(t => noteToPc(t)).filter(x => x !== null).map(n => ((n + transpose) % 12 + 12) % 12);
  return pcs;
}

function updateUI(){
  const transpose = Number(transposeEl.value) || 0;
  transposeVal.textContent = (transpose >= 0 ? `+${transpose}` : `${transpose}`);
  const pcs = parseInputToPcs(chordInput.value, transpose);
  const preferFlats = useFlatsEl.checked;

  if(pcs.length === 0){
    pcsDisplay.textContent = "è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼šâ€”";
    matchesEl.innerHTML = "<li>å°šæœªè¼¸å…¥æˆ–è§£æå‡ºæœ‰æ•ˆéŸ³ã€‚</li>";
    bestMatchEl.innerHTML = "";
    fretInfo.textContent = "å»ºè­°æŠŠä½ï¼šâ€”";
    renderFretGrid(null);
    return;
  }

  const uniquePcs = uniqueSorted(pcs);
  pcsDisplay.textContent = "è§£æå‡ºçš„éŸ³åï¼ˆpitch classesï¼‰ï¼š" + pcsToNames(uniquePcs, preferFlats).join(', ');

  const idents = identifyChordsFromPcs(uniquePcs);
  matchesEl.innerHTML = "";
  if(idents.length === 0){
    matchesEl.innerHTML = "<li>æ‰¾ä¸åˆ°åŒ¹é…çš„å¸¸è¦‹å’Œå¼¦æ¨¡å¼</li>";
  } else {
    idents.slice(0,10).forEach(r => {
      const li = document.createElement('li');
      li.textContent = `${NOTE_NAMES_SHARP[r.root]} ${r.pat.name} â€” intervals: [${r.intervals.join(', ')}]`;
      matchesEl.appendChild(li);
    });
  }

  if(idents.length > 0){
    const best = idents[0];
    bestMatchEl.innerHTML = `<div class="best"><strong>æœ€ä½³åŒ¹é…ï¼š</strong> ${best.display} ï¼ˆæ ¹éŸ³ ${NOTE_NAMES_SHARP[best.root]}ï¼‰</div>`;
  } else {
    bestMatchEl.innerHTML = "";
  }

  // find fretboard
  const fb = findFretboard(uniquePcs);
  if(!fb) {
    fretInfo.textContent = "å»ºè­°æŠŠä½ï¼šç„¡";
    renderFretGrid(null);
  } else {
    fretInfo.textContent = `å»ºè­°æŠŠä½ï¼ˆbase ${fb.base}ï¼ŒåŒ¹é…å¼¦ ${fb.fingering.filter(x=>x!==null).length}/6ï¼‰`;
    renderFretGrid(fb);
  }
}

/* render small fretboard grid. displayedLabels[0] is left-most box.
   fingering array is indexed low->high (0..5). To map to displayed label s (0..5),
   use fingering[5 - s] so that displayedLabels[0] (E') uses fingering[5] (high E).
*/
function renderFretGrid(fb) {
  fretGrid.innerHTML = "";
  for(let s=0;s<6;s++){
    const box = document.createElement('div');
    box.className = 'string-box';
    const label = document.createElement('div');
    label.className = 'string-name';
    label.textContent = displayedLabels[s];
    const fret = document.createElement('div');
    fret.className = 'fret-num';
    let val = 'â€”';
    if(fb && fb.fingering){
      const fing = fb.fingering[5 - s]; // map
      val = (fing === null) ? 'X' : String(fing);
    } else {
      val = 'X';
    }
    fret.textContent = val;
    box.appendChild(label);
    box.appendChild(fret);
    fretGrid.appendChild(box);
  }
}

/* events */
analyzeBtn.addEventListener('click', updateUI);
transposeEl.addEventListener('input', updateUI);
useFlatsEl.addEventListener('change', updateUI);
chordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); updateUI(); } });

/* initial run */
updateUI();

</script>
</body>
</html>
